<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chatter Box | Production Build</title>
    <style>
        /* --- 1. CSS VARIABLES & RESET --- */
        :root { 
            --bg: #f0f2f5; --side: #ffffff; --text: #050505; 
            --accent: #0084ff; --border: #e4e6eb; --card: #ffffff; 
            --msg-me: #0084ff; --msg-them: #e4e6eb; 
            --danger: #ff4d4d; --online: #31a24c;
        }
        body.dark { 
            --bg: #18191a; --side: #242526; --text: #e4e6eb; 
            --accent: #2e89ff; --border: #3e4042; --card: #242526; 
            --msg-them: #3a3b3c;
        }
        * { box-sizing: border-box; outline: none; transition: background 0.2s; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; margin: 0; display: flex; height: 100vh; background: var(--bg); color: var(--text); overflow: hidden; }

        /* --- 2. AUTH SCREEN --- */
        #auth-overlay { position: fixed; inset: 0; background: var(--bg); z-index: 9999; display: flex; justify-content: center; align-items: center; padding: 20px; }
        .auth-card { background: var(--card); padding: 40px; border-radius: 20px; width: 100%; max-width: 400px; box-shadow: 0 10px 40px rgba(0,0,0,0.1); border: 1px solid var(--border); text-align: center; }
        .auth-card h1 { color: #FF8C42; font-style: italic; font-size: 36px; margin: 0 0 10px 0; }
        .link-text { color: var(--accent); cursor: pointer; font-weight: 600; font-size: 14px; margin-top: 20px; display: inline-block; }
        .error-msg { color: var(--danger); font-size: 13px; margin-top: 15px; font-weight: bold; }

        /* --- 3. SIDEBAR --- */
        .sidebar { width: 320px; background: var(--side); border-right: 1px solid var(--border); display: none; flex-direction: column; padding: 25px 15px; }
        .brand { font-size: 28px; font-weight: 900; color: #FF8C42; margin-bottom: 30px; font-style: italic; padding-left: 10px; }
        .nav-btn { display: flex; align-items: center; gap: 15px; padding: 14px; border-radius: 12px; cursor: pointer; color: #65676b; font-weight: 600; margin-bottom: 5px; position: relative; }
        .nav-btn:hover { background: rgba(0,0,0,0.05); }
        .nav-btn.active { background: rgba(0, 132, 255, 0.1); color: var(--accent); }
        .badge { width: 10px; height: 10px; background: var(--danger); border-radius: 50%; position: absolute; right: 15px; display: none; }

        /* --- 4. MAIN CONTENT --- */
        .main-view { flex: 1; padding: 20px; overflow-y: auto; display: flex; justify-content: center; }
        .container { width: 100%; max-width: 800px; background: var(--card); border-radius: 18px; border: 1px solid var(--border); min-height: 90vh; position: relative; }
        .page { display: none; padding: 25px; }
        .page.active { display: block; animation: fade 0.3s; }
        @keyframes fade { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; } }

        /* --- 5. CHAT WINDOW --- */
        #chat-interface { position: fixed; top: 0; right: -600px; bottom: 0; width: 500px; background: var(--card); border-left: 1px solid var(--border); transition: cubic-bezier(0.33, 1, 0.68, 1) 0.5s; z-index: 2000; display: flex; flex-direction: column; box-shadow: -10px 0 40px rgba(0,0,0,0.1); }
        #chat-interface.open { right: 0; }
        .chat-head { padding: 15px 20px; border-bottom: 1px solid var(--border); display: flex; align-items: center; gap: 15px; background: var(--card); }
        .chat-body { flex: 1; padding: 20px; overflow-y: auto; display: flex; flex-direction: column; gap: 8px; background: var(--bg); }
        
        .message-row { display: flex; flex-direction: column; max-width: 75%; }
        .bubble { padding: 12px 18px; border-radius: 18px; font-size: 15px; line-height: 1.4; word-wrap: break-word; }
        
        /* --- 6. COMPONENTS --- */
        .avatar { width: 45px; height: 45px; border-radius: 50%; background-color: #ddd; background-size: cover; background-position: center; display: flex; align-items: center; justify-content: center; font-weight: bold; color: white; flex-shrink: 0; position: relative; }
        .avatar.online::after { content: ''; width: 12px; height: 12px; background: var(--online); border: 2px solid var(--card); border-radius: 50%; position: absolute; bottom: 0; right: 0; }
        
        input, textarea { width: 100%; padding: 14px; border-radius: 12px; border: 1px solid var(--border); background: var(--bg); color: var(--text); margin-bottom: 15px; }
        .btn { background: var(--accent); color: white; border: none; padding: 14px; border-radius: 12px; font-weight: bold; cursor: pointer; font-size: 15px; width: 100%; }
        .btn:hover { opacity: 0.9; }
        
        .list-item { display: flex; align-items: center; gap: 15px; padding: 12px; border-radius: 12px; cursor: pointer; transition: 0.2s; border: 1px solid transparent; }
        .list-item:hover { background: rgba(0,0,0,0.03); border-color: var(--border); }
        .list-item.unread { background: rgba(0, 132, 255, 0.05); border-left: 4px solid var(--accent); }

        /* Gallery Grid */
        .grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px; margin-top: 20px; }
        .grid-img { aspect-ratio: 1; background-color: var(--border); border-radius: 10px; background-size: cover; }
    </style>
</head>
<body>

    <div id="auth-overlay">
        <div class="auth-card">
            <h1>Chatter Box</h1>
            
            <div id="view-login">
                <p>Welcome back</p>
                <input type="email" id="inp-login-email" placeholder="Email">
                <input type="password" id="inp-login-pass" placeholder="Password">
                <button class="btn" onclick="app.login()">Log In</button>
                <div class="link-text" onclick="app.toggleAuth(true)">Create Account</div>
            </div>

            <div id="view-signup" style="display:none">
                <p>Create Profile</p>
                <input type="text" id="inp-reg-name" placeholder="Display Name">
                <input type="email" id="inp-reg-email" placeholder="Email">
                <input type="password" id="inp-reg-pass" placeholder="Password">
                <button class="btn" onclick="app.register()">Sign Up</button>
                <div class="link-text" onclick="app.toggleAuth(false)">Back to Login</div>
            </div>
            
            <div id="auth-error" class="error-msg"></div>
        </div>
    </div>

    <div id="app-sidebar" class="sidebar">
        <div class="brand">Chatter Box</div>
        <div class="nav-btn active" onclick="app.nav('home')">üè† Inbox <div id="badge-home" class="badge"></div></div>
        <div class="nav-btn" onclick="app.nav('search')">üîç Search</div>
        <div class="nav-btn" onclick="app.nav('profile')">üë§ Profile</div>
        <div class="nav-btn" onclick="app.nav('settings')">‚öôÔ∏è Settings</div>
        <div style="margin-top:auto" class="nav-btn" onclick="app.logout()"><span style="color:var(--danger)">üö™ Logout</span></div>
    </div>

    <div class="main-view">
        <div class="container">
            
            <div id="page-home" class="page active">
                <h2>Messages</h2>
                <div id="list-inbox">Loading...</div>
            </div>

            <div id="page-search" class="page">
                <div style="display:flex; justify-content:space-between; align-items:center">
                    <h2>Discover</h2>
                    <button class="btn" style="width:auto; padding:8px 15px;" onclick="app.createGroup()">+ Group</button>
                </div>
                <input type="text" id="inp-search" placeholder="Search users..." oninput="app.search(this.value)">
                <div id="list-search"></div>
            </div>

            <div id="page-profile" class="page">
                <div style="text-align:center">
                    <div id="profile-img" class="avatar" style="width:100px; height:100px; margin:0 auto 15px; font-size:40px; border:4px solid var(--accent)"></div>
                    <h2 id="profile-name"></h2>
                    <p id="profile-bio" style="color:#888"></p>
                    <input type="file" id="inp-file" hidden onchange="app.uploadImage(this)">
                    <button class="btn" style="width:auto" onclick="document.getElementById('inp-file').click()">Upload Photo</button>
                </div>
                <div id="profile-gallery" class="grid"></div>
            </div>

            <div id="page-settings" class="page">
                <h2>Settings</h2>
                <div style="margin-bottom:20px; padding:20px; background:var(--bg); border-radius:15px;">
                    <h4>Appearance</h4>
                    <button class="btn" onclick="document.body.classList.toggle('dark')">Toggle Dark Mode</button>
                </div>
            </div>

        </div>
    </div>

    <div id="chat-interface">
        <div class="chat-head">
            <button onclick="document.getElementById('chat-interface').classList.remove('open')" style="background:none; border:none; font-size:24px; cursor:pointer; color:var(--text)">√ó</button>
            <div id="chat-head-img" class="avatar"></div>
            <b id="chat-head-name" style="font-size:18px"></b>
        </div>
        <div id="chat-feed" class="chat-body"></div>
        <div style="padding:15px; border-top:1px solid var(--border); display:flex; gap:10px; background:var(--card)">
            <input type="text" id="inp-msg" placeholder="Type a message..." style="margin:0; border-radius:25px">
            <button class="btn" style="width:50px; border-radius:50%" onclick="app.send()">‚û§</button>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, onAuthStateChanged, signInWithEmailAndPassword, createUserWithEmailAndPassword, signOut } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getDatabase, ref, set, push, onValue, get, update, serverTimestamp, onDisconnect } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

        // CONFIG
        const config = { apiKey: "AIzaSyAF0IDQU21LWJ2Rggb7J0rY4F6UlvZaVZg", authDomain: "chatterbox-4b7dd.firebaseapp.com", databaseURL: "https://chatterbox-4b7dd-default-rtdb.firebaseio.com", projectId: "chatterbox-4b7dd" };
        const firebaseApp = initializeApp(config);
        const auth = getAuth(firebaseApp);
        const db = getDatabase(firebaseApp);

        let currentUser = null;
        let activeChatId = null;
        let isGroup = false;

        const app = {
            // AUTH
            toggleAuth: (showReg) => {
                document.getElementById('view-login').style.display = showReg ? 'none' : 'block';
                document.getElementById('view-signup').style.display = showReg ? 'block' : 'none';
            },
            login: () => {
                const e = document.getElementById('inp-login-email').value;
                const p = document.getElementById('inp-login-pass').value;
                signInWithEmailAndPassword(auth, e, p).catch(err => document.getElementById('auth-error').innerText = err.message);
            },
            register: () => {
                const n = document.getElementById('inp-reg-name').value;
                const e = document.getElementById('inp-reg-email').value;
                const p = document.getElementById('inp-reg-pass').value;
                createUserWithEmailAndPassword(auth, e, p).then(cred => {
                    set(ref(db, `users/${cred.user.uid}`), { name: n, email: e, pfp: '', bio: 'Using Chatter Box' });
                }).catch(err => document.getElementById('auth-error').innerText = err.message);
            },
            logout: () => signOut(auth).then(() => location.reload()),

            // NAVIGATION
            nav: (page) => {
                document.querySelectorAll('.page').forEach(el => el.classList.remove('active'));
                document.getElementById(`page-${page}`).classList.add('active');
                document.querySelectorAll('.nav-btn').forEach(el => el.classList.remove('active'));
                event.currentTarget.classList.add('active');
                if(page === 'profile') app.loadProfile();
            },

            // MESSAGING FIX INTEGRATED HERE
            openChat: (id, name, pfp, type) => {
                activeChatId = id;
                isGroup = type === 'group';
                
                const chatPanel = document.getElementById('chat-interface');
                chatPanel.classList.add('open');
                document.getElementById('chat-head-name').innerText = name;
                app.renderAvatar(document.getElementById('chat-head-img'), pfp, name);

                // Mark read
                update(ref(db, `users/${currentUser.uid}/chats/${id}`), { unread: false });

                const roomId = isGroup ? id : [currentUser.uid, id].sort().join('_');
                
                // Realtime Message Listener
                onValue(ref(db, `messages/${roomId}`), snap => {
                    const feed = document.getElementById('chat-feed');
                    feed.innerHTML = '';
                    snap.forEach(msg => {
                        const m = msg.val();
                        const isMe = m.sender === currentUser.uid;
                        const row = document.createElement('div');
                        row.className = 'message-row';
                        row.style.alignSelf = isMe ? 'flex-end' : 'flex-start';
                        
                        row.innerHTML = `
                            <div class="bubble" style="background:${isMe?'var(--msg-me)':'var(--msg-them)'}; color:${isMe?'#fff':'var(--text)'}">
                                ${m.text}
                            </div>
                            <div style="font-size:10px; opacity:0.6; margin-top:2px; text-align:${isMe?'right':'left'}">
                                ${new Date(m.timestamp).toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'})}
                            </div>
                        `;
                        feed.appendChild(row);
                    });
                    feed.scrollTop = feed.scrollHeight;
                });
            },

            send: () => {
                const txt = document.getElementById('inp-msg').value.trim();
                if(!txt || !activeChatId) return;

                const roomId = isGroup ? activeChatId : [currentUser.uid, activeChatId].sort().join('_');
                const timestamp = Date.now();

                // 1. Push Message
                push(ref(db, `messages/${roomId}`), {
                    sender: currentUser.uid,
                    text: txt,
                    timestamp: timestamp
                });

                // 2. Update Sender's List
                update(ref(db, `users/${currentUser.uid}/chats/${activeChatId}`), {
                    lastMsg: txt, time: timestamp, unread: false, type: isGroup ? 'group' : 'private'
                });

                // 3. Update Receiver's List (CRITICAL FIX)
                if(!isGroup) {
                    update(ref(db, `users/${activeChatId}/chats/${currentUser.uid}`), {
                        lastMsg: txt, time: timestamp, unread: true, type: 'private'
                    });
                } else {
                    // Simple Group Update (fetches members from group node)
                    get(ref(db, `groups/${activeChatId}/members`)).then(snap => {
                       if(snap.exists()) {
                           snap.forEach(m => {
                               if(m.key !== currentUser.uid) {
                                   update(ref(db, `users/${m.key}/chats/${activeChatId}`), {
                                       lastMsg: txt, time: timestamp, unread: true, type: 'group'
                                   });
                               }
                           })
                       } 
                    });
                }

                document.getElementById('inp-msg').value = '';
            },

            // SEARCH & LISTS
            search: (query) => {
                if(!query) return document.getElementById('list-search').innerHTML = '';
                get(ref(db, 'users')).then(snap => {
                    const list = document.getElementById('list-search');
                    list.innerHTML = '';
                    snap.forEach(u => {
                        const user = u.val();
                        if(user.name.toLowerCase().includes(query.toLowerCase()) && u.key !== currentUser.uid) {
                            const item = document.createElement('div');
                            item.className = 'list-item';
                            item.innerHTML = `<div class="avatar"></div><b>${user.name}</b>`;
                            app.renderAvatar(item.querySelector('.avatar'), user.pfp, user.name);
                            item.onclick = () => app.openChat(u.key, user.name, user.pfp, 'private');
                            list.appendChild(item);
                        }
                    });
                });
            },

            createGroup: () => {
                const name = prompt("Group Name:");
                if(!name) return;
                const newRef = push(ref(db, 'groups'));
                const gid = newRef.key;
                
                set(newRef, { name: name, creator: currentUser.uid });
                update(ref(db, `groups/${gid}/members/${currentUser.uid}`), true);
                update(ref(db, `users/${currentUser.uid}/chats/${gid}`), { type: 'group', time: Date.now(), unread: false });
            },

            // PROFILE & UTILS
            loadProfile: () => {
                get(ref(db, `users/${currentUser.uid}`)).then(s => {
                    const d = s.val();
                    document.getElementById('profile-name').innerText = d.name;
                    document.getElementById('profile-bio').innerText = d.bio;
                    app.renderAvatar(document.getElementById('profile-img'), d.pfp, d.name);
                });
                onValue(ref(db, `galleries/${currentUser.uid}`), snap => {
                    const g = document.getElementById('profile-gallery');
                    g.innerHTML = '';
                    snap.forEach(i => g.innerHTML += `<div class="grid-img" style="background-image:url(${i.val()})"></div>`);
                });
            },

            uploadImage: (input) => {
                const reader = new FileReader();
                reader.onload = () => push(ref(db, `galleries/${currentUser.uid}`), reader.result);
                reader.readAsDataURL(input.files[0]);
            },

            renderAvatar: (el, url, name) => {
                if(url) { el.style.backgroundImage = `url(${url})`; el.innerText = ''; }
                else { el.innerText = name ? name[0].toUpperCase() : '?'; el.style.backgroundImage = 'none'; }
            }
        };

        // GLOBAL LISTENER
        onAuthStateChanged(auth, user => {
            if(user) {
                currentUser = user;
                document.getElementById('auth-overlay').style.display = 'none';
                document.getElementById('app-sidebar').style.display = 'flex';
                
                // Load Inbox
                onValue(ref(db, `users/${user.uid}/chats`), snap => {
                    const list = document.getElementById('list-inbox');
                    list.innerHTML = '';
                    let hasUnread = false;
                    
                    if(!snap.exists()) list.innerHTML = '<div style="padding:20px; color:#888">No messages yet.</div>';

                    snap.forEach(c => {
                        const chat = c.val();
                        if(chat.unread) hasUnread = true;
                        
                        const refPath = chat.type === 'group' ? `groups/${c.key}` : `users/${c.key}`;
                        get(ref(db, refPath)).then(meta => {
                            if(!meta.exists()) return;
                            const d = meta.val();
                            const div = document.createElement('div');
                            div.className = `list-item ${chat.unread ? 'unread' : ''}`;
                            div.innerHTML = `
                                <div class="avatar"></div>
                                <div>
                                    <div style="font-weight:bold">${d.name}</div>
                                    <div style="font-size:12px; opacity:0.7">${chat.lastMsg || 'New conversation'}</div>
                                </div>
                            `;
                            app.renderAvatar(div.querySelector('.avatar'), d.pfp, d.name);
                            div.onclick = () => app.openChat(c.key, d.name, d.pfp, chat.type);
                            list.appendChild(div);
                        });
                    });
                    document.getElementById('badge-home').style.display = hasUnread ? 'block' : 'none';
                });

            } else {
                document.getElementById('auth-overlay').style.display = 'flex';
                document.getElementById('app-sidebar').style.display = 'none';
            }
        });

        // Expose app to window for HTML buttons
        window.app = app;
    </script>
</body>
</html>
