<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chatter Box</title>
    <style>
        body { font-family: sans-serif; background: #0f0c29; color: white; display: flex; justify-content: center; align-items: center; height: 100vh; margin: 0; overflow: hidden; }
        .container { width: 90%; max-width: 420px; background: rgba(255,255,255,0.1); padding: 25px; border-radius: 25px; border: 1px solid rgba(255,255,255,0.15); }
        input { width: 100%; padding: 12px; margin: 8px 0; border-radius: 10px; border: none; box-sizing: border-box; }
        button { width: 100%; padding: 12px; cursor: pointer; background: #2575fc; color: white; border: none; border-radius: 10px; font-weight: bold; }
        #chatSection, #settingsSection { display: none; text-align: left; }
        #chatWindow { height: 320px; overflow-y: auto; background: rgba(0,0,0,0.2); margin: 15px 0; padding: 15px; border-radius: 15px; }
        .msg { margin-bottom: 12px; padding: 10px; background: rgba(255,255,255,0.1); border-radius: 10px; position: relative; }
        .time { font-size: 0.65rem; opacity: 0.5; display: block; margin-top: 5px; text-align: right; }
        .small-btn { width: auto; padding: 6px 12px; font-size: 0.75rem; margin-left: 5px; }
        .danger { background: #ff4b2b; }
        .sender-tag { font-size: 0.75rem; font-weight: bold; color: #2575fc; display: block; margin-bottom: 2px; }
    </style>
</head>
<body>

    <div class="container">
        <div id="authSection">
            <h2 id="authTitle" style="text-align:center;">Chatter Box</h2>
            <div id="nickWrap" style="display:none;"><input type="text" id="nick" placeholder="Choose a Nickname"></div>
            <input type="email" id="email" placeholder="Email">
            <input type="password" id="pass" placeholder="Password">
            <button id="authBtn">Continue</button>
            <p id="toggle" style="cursor:pointer; font-size: 0.85rem; text-align:center; margin-top:20px; color: #2575fc;">New? Register</p>
        </div>

        <div id="chatSection">
            <div style="float:right; display: flex; gap: 5px;">
                <button class="small-btn" id="toSet">Settings</button>
                <button class="small-btn danger" id="Sign Out">Sign Out</button>
            </div>
            <h3 style="margin: 0;">Live Chat</h3>
            <div id="chatWindow"></div>
            <div style="display:flex; gap:8px;">
                <input type="text" id="mIn" placeholder="Type a message...">
                <button id="sBtn" style="width:auto; padding: 0 20px;">Send</button>
            </div>
        </div>

        <div id="settingsSection">
            <h3>Settings</h3>
            <input type="text" id="newNick" placeholder="New Nickname">
            <button id="saveNick">Save Changes</button>
            <button id="clearChat" class="danger" style="margin-top:20px;">ADMIN: Clear All Messages</button>
            <button id="back" class="small-btn" style="width:100%; margin-top:10px;">Back to Chat</button>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, onAuthStateChanged, signOut, updateProfile } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getDatabase, ref, push, onChildAdded, remove } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

        const config = {
            apiKey: "AIzaSyAF0IDQU21LWJ2Rggb7J0rY4F6UlvZaVZg",
            authDomain: "chatterbox-4b7dd.firebaseapp.com",
            databaseURL: "https://chatterbox-4b7dd-default-rtdb.firebaseio.com", 
            projectId: "chatterbox-4b7dd",
            storageBucket: "chatterbox-4b7dd.firebasestorage.app",
            messagingSenderId: "509263602746",
            appId: "1:509263602746:web:01051fc91ecb3bfa384103"
        };

        const app = initializeApp(config);
        const auth = getAuth(app);
        const db = getDatabase(app);
        let mode = "login";

        const showView = (id) => {
            document.getElementById("authSection").style.display = "none";
            document.getElementById("chatSection").style.display = "none";
            document.getElementById("settingsSection").style.display = "none";
            document.getElementById(id).style.display = "block";
        };

        // --- AUTH LOGIC ---
        document.getElementById('toggle').onclick = () => {
            mode = (mode === "login") ? "reg" : "login";
            document.getElementById('authTitle').innerText = mode === "login" ? "Sign In" : "Register";
            document.getElementById('nickWrap').style.display = mode === "login" ? "none" : "block";
        };

        document.getElementById('authBtn').onclick = () => {
            const e = document.getElementById('email').value, p = document.getElementById('pass').value, n = document.getElementById('nick').value;
            if(mode === "reg") {
                createUserWithEmailAndPassword(auth, e, p).then(r => updateProfile(r.user, {displayName: n})).catch(err => alert(err.message));
            } else {
                signInWithEmailAndPassword(auth, e, p).catch(err => alert(err.message));
            }
        };

        document.getElementById('outBtn').onclick = () => signOut(auth).then(() => location.reload());

        // --- SETTINGS LOGIC ---
        document.getElementById('toSet').onclick = () => showView("settingsSection");
        document.getElementById('back').onclick = () => showView("chatSection");
        
        document.getElementById('saveNick').onclick = () => {
            const n = document.getElementById('newNick').value;
            if(n) updateProfile(auth.currentUser, {displayName: n}).then(() => { alert("Nickname Updated!"); showView("chatSection"); });
        };

        document.getElementById('clearChat').onclick = () => {
            if(confirm("Permanently delete ALL messages?")) {
                remove(ref(db, 'messages')).then(() => {
                    document.getElementById('chatWindow').innerHTML = "";
                    alert("Chat Cleared");
                });
            }
        };

        // --- CORE CHAT LOGIC ---
        onAuthStateChanged(auth, (u) => {
            if(u) { showView("chatSection"); runChat(u); } else { showView("authSection"); }
        });

        function runChat(u) {
            const mRef = ref(db, 'messages');
            
            const doSend = () => {
                const text = document.getElementById('mIn').value;
                const now = new Date();
                const timeString = now.getHours() + ":" + now.getMinutes().toString().padStart(2, '0');
                
                if(text.trim()) {
                    push(mRef, { 
                        sender: auth.currentUser.displayName || u.email.split('@')[0], 
                        content: text,
                        time: timeString
                    });
                    document.getElementById('mIn').value = "";
                }
            };

            document.getElementById('sBtn').onclick = doSend;

            // FIX: ENTER KEY LISTENER
            document.getElementById('mIn').addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    doSend();
                }
            });

            document.getElementById('chatWindow').innerHTML = "";
            onChildAdded(mRef, (snap) => {
                const d = snap.val();
                const div = document.createElement('div');
                div.className = "msg";
                div.innerHTML = `<span class="sender-tag">${d.sender}</span>${d.content}<span class="time">${d.time || ''}</span>`;
                document.getElementById('chatWindow').appendChild(div);
                document.getElementById('chatWindow').scrollTop = document.getElementById('chatWindow').scrollHeight;
            });
        }
    </script>
</body>
</html>
