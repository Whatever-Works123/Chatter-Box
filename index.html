<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chatter Box | Fixed Sign Up</title>
    <style>
        * { box-sizing: border-box; outline: none; }
        body { font-family: -apple-system, sans-serif; margin: 0; display: flex; height: 100vh; background: #fafafa; color: #262626; }
        
        #auth-screen { position: fixed; inset: 0; background: #fafafa; z-index: 10000; display: flex; justify-content: center; align-items: center; }
        .auth-box { text-align:center; width:350px; border:1px solid #dbdbdb; padding:40px; background: white; border-radius: 1px; }
        
        .sidebar { width: 245px; border-right: 1px solid #dbdbdb; padding: 20px; display: none; flex-direction: column; background: white; }
        .logo { font-size: 28px; font-weight: bold; margin-bottom: 40px; font-style: italic; color: #FF8C42; cursor: pointer; }
        
        .main { flex: 1; overflow-y: auto; display: flex; justify-content: center; }
        .container { width: 100%; max-width: 600px; padding: 20px; }
        .page { display: none; width: 100%; }

        .btn-b { background: #0095f6; color: white; border: none; padding: 10px; border-radius: 8px; font-weight: 600; cursor: pointer; width: 100%; margin-bottom: 10px; }
        .btn-g { background: #efefef; color: black; border: none; padding: 10px; border-radius: 8px; font-weight: 600; cursor: pointer; width: 100%; }
        input { width: 100%; padding: 10px; margin-bottom: 10px; border: 1px solid #dbdbdb; border-radius: 3px; background: #fafafa; }
        
        .nav-item { padding: 12px; cursor: pointer; border-radius: 8px; margin-bottom: 5px; display: flex; gap: 15px; }
        .nav-item.active { font-weight: bold; background: #f2f2f2; }
        
        /* Profile styles */
        .pfp-l { width: 120px; height: 120px; border-radius: 50%; background-size: cover; background-position: center; border: 1px solid #dbdbdb; margin-right: 30px; }
        .profile-top { display: flex; align-items: center; margin-bottom: 40px; }
        #edit-form { display: none; background: #fff; border: 1px solid #dbdbdb; padding: 15px; border-radius: 8px; margin-top: 10px; }
    </style>
</head>
<body>

    <div id="auth-screen">
        <div class="auth-box">
            <h1 style="color:#FF8C42; font-style:italic; font-size: 32px; margin-bottom: 30px;">Chatter Box</h1>
            <input type="email" id="email" placeholder="Email">
            <input type="password" id="password" placeholder="Password">
            <button id="login-btn" class="btn-b">Log In</button>
            <div style="margin: 15px 0; color: #8e8e8e; font-size: 13px;">OR</div>
            <button id="signup-btn" class="btn-g">Create New Account</button>
        </div>
    </div>

    <div id="side-nav" class="sidebar">
        <div class="logo" onclick="nav('home-page')">Chatter Box</div>
        <div class="nav-item active" id="n-home" onclick="nav('home-page', this)">üè† Home</div>
        <div class="nav-item" id="n-search" onclick="nav('search-page', this)">üîç Search</div>
        <div class="nav-item" id="n-profile" onclick="nav('profile-page', this)">üë§ Profile</div>
        <button id="logout-btn" style="margin-top:auto; background:none; border:none; color:#ed4956; cursor:pointer; text-align:left; font-weight:bold;">Logout</button>
    </div>

    <div class="main">
        <div class="container">
            <div id="home-page" class="page" style="display:block;">
                <div id="feed"></div>
            </div>

            <div id="search-page" class="page">
                <input type="text" id="s-query" placeholder="Search for people...">
                <div id="s-results"></div>
            </div>

            <div id="profile-page" class="page">
                <div class="profile-top">
                    <div id="p-pfp" class="pfp-l"></div>
                    <div>
                        <div style="display:flex; align-items:center; gap:15px; margin-bottom:10px;">
                            <h2 id="p-name" style="margin:0; font-weight:400;"></h2>
                            <div id="p-actions"></div>
                        </div>
                        <div id="p-bio"></div>
                        <div id="edit-form">
                            <label for="pfp-in" style="color:#0095f6; cursor:pointer; font-weight:bold; font-size: 13px;">Change Profile Photo</label>
                            <input type="file" id="pfp-in" accept="image/*" style="display:none">
                            <input type="text" id="edit-name" placeholder="Display Name">
                            <textarea id="edit-bio" placeholder="Bio..."></textarea>
                            <button class="btn-b" onclick="saveProfile()">Save Changes</button>
                            <button class="btn-g" onclick="toggleEdit(false)">Cancel</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, onAuthStateChanged, signInWithEmailAndPassword, createUserWithEmailAndPassword, signOut } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getDatabase, ref, set, get, update, onValue } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

        const config = { 
            apiKey: "AIzaSyAF0IDQU21LWJ2Rggb7J0rY4F6UlvZaVZg", 
            authDomain: "chatterbox-4b7dd.firebaseapp.com", 
            databaseURL: "https://chatterbox-4b7dd-default-rtdb.firebaseio.com", 
            projectId: "chatterbox-4b7dd" 
        };

        const app = initializeApp(config);
        const auth = getAuth(app);
        const db = getDatabase(app);

        // --- SIGN UP LOGIC ---
        document.getElementById('signup-btn').onclick = async () => {
            const email = document.getElementById('email').value;
            const pass = document.getElementById('password').value;
            
            if (pass.length < 6) return alert("Password must be at least 6 characters.");

            try {
                const res = await createUserWithEmailAndPassword(auth, email, pass);
                // Create user data in database immediately
                await set(ref(db, 'users/' + res.user.uid), {
                    name: email.split('@')[0],
                    pfp: 'https://i.pravatar.cc/150',
                    bio: "Welcome to my Chatter Box!"
                });
                console.log("Account created successfully!");
            } catch (e) {
                alert("Sign up failed: " + e.message);
            }
        };

        // --- LOG IN LOGIC ---
        document.getElementById('login-btn').onclick = () => {
            signInWithEmailAndPassword(auth, document.getElementById('email').value, document.getElementById('password').value)
                .catch(e => alert("Login failed: " + e.message));
        };

        document.getElementById('logout-btn').onclick = () => signOut(auth).then(() => location.reload());

        onAuthStateChanged(auth, (user) => {
            if (user) {
                document.getElementById('auth-screen').style.display = 'none';
                document.getElementById('side-nav').style.display = 'flex';
                initDashboard();
            }
        });

        // --- NAVIGATION ---
        window.nav = (id, el) => {
            document.querySelectorAll('.page').forEach(p => p.style.display = 'none');
            document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
            document.getElementById(id).style.display = 'block';
            if(el) el.classList.add('active');
            if(id === 'profile-page') viewProfile(auth.currentUser.uid);
        };

        // --- PROFILE LOGIC ---
        window.viewProfile = (uid) => {
            onValue(ref(db, 'users/' + uid), snap => {
                const data = snap.val();
                if (!data) return;
                document.getElementById('p-name').innerText = data.name;
                document.getElementById('p-pfp').style.backgroundImage = `url(${data.pfp})`;
                document.getElementById('p-bio').innerText = data.bio || "";
                
                const acts = document.getElementById('p-actions');
                if(uid === auth.currentUser.uid) {
                    acts.innerHTML = `<button class="btn-g" style="width:auto;" onclick="toggleEdit(true)">Edit Profile</button>`;
                } else {
                    acts.innerHTML = `<button class="btn-b" style="width:auto;">Follow</button>`;
                }
            });
        };

        window.toggleEdit = (show) => {
            document.getElementById('edit-form').style.display = show ? 'block' : 'none';
            document.getElementById('p-bio').style.display = show ? 'none' : 'block';
        };

        window.saveProfile = () => {
            const file = document.getElementById('pfp-in').files[0];
            const name = document.getElementById('edit-name').value;
            const bio = document.getElementById('edit-bio').value;

            const pushUpdate = (photo = null) => {
                const data = { name, bio };
                if(photo) data.pfp = photo;
                update(ref(db, 'users/' + auth.currentUser.uid), data).then(() => toggleEdit(false));
            };

            if(file) {
                const reader = new FileReader();
                reader.onload = () => pushUpdate(reader.result);
                reader.readAsDataURL(file);
            } else {
                pushUpdate();
            }
        };

        function initDashboard() {
            // Placeholder for feed and search logic
            console.log("Dashboard Loaded");
        }
    </script>
</body>
</html>
