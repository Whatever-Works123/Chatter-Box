<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chatter Box</title>
    <style>
        body { font-family: sans-serif; background: #0f0c29; color: white; display: flex; justify-content: center; align-items: center; height: 100vh; margin: 0; overflow: hidden; }
        .container { width: 95%; max-width: 420px; background: rgba(255,255,255,0.1); padding: 25px; border-radius: 25px; border: 1px solid rgba(255,255,255,0.15); height: 85vh; display: flex; flex-direction: column; box-sizing: border-box; }
        input { width: 100%; padding: 12px; margin: 8px 0; border-radius: 10px; border: none; box-sizing: border-box; background: white; color: black; }
        button { padding: 12px; cursor: pointer; background: #2575fc; color: white; border: none; border-radius: 10px; font-weight: bold; width: 100%; margin-top: 10px; }
        #authSection, #chatSection, #friendsSection { display: none; flex-direction: column; height: 100%; }
        #chatWindow, #friendsList { flex: 1; overflow-y: auto; background: rgba(0,0,0,0.2); margin: 10px 0; padding: 15px; border-radius: 15px; }
        .msg { margin-bottom: 12px; padding: 10px; background: rgba(255,255,255,0.1); border-radius: 10px; font-size: 0.9rem; }
        .friend-item { display: flex; justify-content: space-between; align-items: center; padding: 10px; background: rgba(255,255,255,0.05); margin-bottom: 5px; border-radius: 10px; }
        .nav-bar { display: flex; justify-content: space-around; padding-top: 15px; border-top: 1px solid rgba(255,255,255,0.1); }
        .nav-item { cursor: pointer; opacity: 0.6; font-size: 0.75rem; font-weight: bold; text-transform: uppercase; }
        .nav-item.active { opacity: 1; color: #2575fc; }
        .small-btn { padding: 5px 10px; font-size: 0.7rem; width: auto; margin: 0; }
    </style>
</head>
<body>

    <div class="container">
        <div id="authSection">
            <h2 id="authTitle" style="text-align:center;">Chatter Box</h2>
            <div id="nickWrap" style="display:none;"><input type="text" id="regNick" placeholder="Choose a Nickname"></div>
            <input type="email" id="loginEmail" placeholder="Email">
            <input type="password" id="loginPass" placeholder="Password">
            <button id="mainAuthBtn">Continue</button>
            <p id="authToggle" style="cursor:pointer; text-align:center; font-size: 0.8rem; color: #2575fc; margin-top: 15px;">New? Register</p>
        </div>

        <div id="friendsSection">
            <h3 style="margin: 0;">Friends</h3>
            <div style="display:flex; gap:5px; margin-top:10px;">
                <input type="text" id="friendEmailInput" placeholder="Friend's Email" style="margin:0;">
                <button id="addFriendBtn" class="small-btn">Add</button>
            </div>
            <div id="friendsList"></div>
            <div class="nav-bar">
                <div class="nav-item active">Friends</div>
                <div class="nav-item" onclick="view('chatSection')">Global</div>
                <div class="nav-item" onclick="logOut()">Sign Out</div>
            </div>
        </div>

        <div id="chatSection">
            <h3 style="margin: 0;">Global Chat</h3>
            <div id="chatWindow"></div>
            <div style="display:flex; gap:8px;">
                <input type="text" id="msgInput" placeholder="Message..." style="margin:0;">
                <button id="sendBtn" style="width:auto; padding: 0 20px;">Send</button>
            </div>
            <div class="nav-bar">
                <div class="nav-item" onclick="view('friendsSection')">Friends</div>
                <div class="nav-item active">Global</div>
                <div class="nav-item" onclick="logOut()">Sign Out</div>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, onAuthStateChanged, signOut, updateProfile } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getDatabase, ref, push, onChildAdded, set, get } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

        const firebaseConfig = {
            apiKey: "AIzaSyAF0IDQU21LWJ2Rggb7J0rY4F6UlvZaVZg",
            authDomain: "chatterbox-4b7dd.firebaseapp.com",
            databaseURL: "https://chatterbox-4b7dd-default-rtdb.firebaseio.com", 
            projectId: "chatterbox-4b7dd",
            storageBucket: "chatterbox-4b7dd.firebasestorage.app",
            messagingSenderId: "509263602746",
            appId: "1:509263602746:web:01051fc91ecb3bfa384103"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getDatabase(app);
        let isRegisterMode = false;

        // Navigation
        window.view = (id) => {
            document.getElementById('authSection').style.display = 'none';
            document.getElementById('friendsSection').style.display = 'none';
            document.getElementById('chatSection').style.display = 'none';
            document.getElementById(id).style.display = 'flex';
        };

        window.logOut = () => signOut(auth).then(() => location.reload());

        // Toggle Sign In / Register
        document.getElementById('authToggle').onclick = () => {
            isRegisterMode = !isRegisterMode;
            document.getElementById('authTitle').innerText = isRegisterMode ? "Create Account" : "Chatter Box";
            document.getElementById('nickWrap').style.display = isRegisterMode ? "block" : "none";
            document.getElementById('authToggle').innerText = isRegisterMode ? "Back to Sign In" : "New? Register";
        };

        // AUTH BUTTON CLICK
        document.getElementById('mainAuthBtn').onclick = () => {
            const email = document.getElementById('loginEmail').value;
            const pass = document.getElementById('loginPass').value;
            const nick = document.getElementById('regNick').value;

            if(!email || !pass) return alert("Fill in email and password");

            if(isRegisterMode) {
                createUserWithEmailAndPassword(auth, email, pass)
                .then((res) => {
                    updateProfile(res.user, { displayName: nick });
                    set(ref(db, 'users/' + res.user.uid), { email: email.toLowerCase(), name: nick });
                }).catch(e => alert(e.message));
            } else {
                signInWithEmailAndPassword(auth, email, pass).catch(e => alert(e.message));
            }
        };

        // STATE LISTENER
        onAuthStateChanged(auth, (user) => {
            if (user) {
                view('friendsSection');
                initApp(user);
            } else {
                view('authSection');
            }
        });

        function initApp(user) {
            // Friend Addition
            document.getElementById('addFriendBtn').onclick = () => {
                const search = document.getElementById('friendEmailInput').value.toLowerCase().trim();
                get(ref(db, 'users')).then(snap => {
                    let friendId = null;
                    snap.forEach(c => { if(c.val().email === search) friendId = c.key; });
                    if(friendId && friendId !== user.uid) {
                        set(ref(db, `friends/${user.uid}/${friendId}`), true);
                        alert("Added!");
                    } else { alert("User not found"); }
                });
            };

            // Load Friends
            const fList = document.getElementById('friendsList');
            fList.innerHTML = "";
            onChildAdded(ref(db, `friends/${user.uid}`), (snap) => {
                get(ref(db, `users/${snap.key}`)).then(uSnap => {
                    const div = document.createElement('div');
                    div.className = 'friend-item';
                    div.innerHTML = `<span>${uSnap.val().name}</span> <button class="small-btn">Chat</button>`;
                    fList.appendChild(div);
                });
            });

            // Global Chat
            const cRef = ref(db, 'messages');
            document.getElementById('sendBtn').onclick = () => {
                const txt = document.getElementById('msgInput').value;
                if(txt.trim()) {
                    push(cRef, { sender: user.displayName || user.email, content: txt });
                    document.getElementById('msgInput').value = "";
                }
            };

            const cWin = document.getElementById('chatWindow');
            cWin.innerHTML = "";
            onChildAdded(cRef, (snap) => {
                const d = snap.val();
                const div = document.createElement('div');
                div.className = "msg";
                div.innerHTML = `<strong>${d.sender}:</strong> ${d.content}`;
                cWin.appendChild(div);
                cWin.scrollTop = cWin.scrollHeight;
            });
        }
    </script>
</body>
</html>
