<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chatter Box</title>
    <style>
        body { font-family: sans-serif; background: #0f0c29; color: white; display: flex; justify-content: center; align-items: center; height: 100vh; margin: 0; }
        .container { width: 90%; max-width: 400px; background: rgba(255,255,255,0.1); padding: 30px; border-radius: 20px; text-align: center; border: 1px solid rgba(255,255,255,0.2); box-shadow: 0 10px 30px rgba(0,0,0,0.5); position: relative; }
        input { width: 100%; padding: 12px; margin: 10px 0; border-radius: 8px; border: none; box-sizing: border-box; background: white; color: black; }
        button { width: 100%; padding: 12px; cursor: pointer; background: #2575fc; color: white; border: none; border-radius: 8px; font-weight: bold; margin-top: 10px; }
        
        /* Sections */
        #chatSection, #settingsSection { display: none; text-align: left; }
        
        #chatWindow { height: 300px; overflow-y: auto; background: rgba(0,0,0,0.3); margin: 15px 0; padding: 15px; border-radius: 10px; border: 1px solid rgba(255,255,255,0.1); }
        .msg { margin-bottom: 12px; padding: 10px; background: rgba(255,255,255,0.1); border-radius: 10px; font-size: 0.9rem; }
        .toggle-text { margin-top: 20px; font-size: 0.8rem; color: #2575fc; cursor: pointer; text-decoration: underline; }
        
        .nav-btn { background: rgba(255,255,255,0.2); width: auto; padding: 5px 10px; font-size: 0.7rem; border-radius: 5px; }
        .logout { background: #ff4b2b; }
        
        .header-btns { display: flex; gap: 5px; float: right; }
        #nicknameBox { display: none; }
    </style>
</head>
<body>

    <div class="container">
        <div id="authSection">
            <h1 id="authTitle">Chatter Box</h1>
            <div id="nicknameBox">
                <input type="text" id="nickname" placeholder="Choose a Nickname">
            </div>
            <input type="email" id="email" placeholder="Email">
            <input type="password" id="password" placeholder="Password (6+ chars)">
            <button id="authBtn">Sign In</button>
            <div id="toggleLink" class="toggle-text">New here? Create Account</div>
        </div>

        <div id="chatSection">
            <div class="header-btns">
                <button class="nav-btn" id="toSettingsBtn">Settings</button>
                <button class="nav-btn logout" id="logoutBtn">Log Out</button>
            </div>
            <h3 style="margin: 0 0 15px 0;">Messages</h3>
            <div id="chatWindow"></div>
            <div style="display: flex; gap: 10px;">
                <input type="text" id="msgInput" placeholder="Message..." style="margin: 0;">
                <button id="sendBtn" style="width: auto; margin: 0;">Send</button>
            </div>
        </div>

        <div id="settingsSection">
            <button class="nav-btn" id="backToChatBtn">‚Üê Back</button>
            <h3 style="text-align: center;">Settings</h3>
            <p style="font-size: 0.8rem; opacity: 0.7;">Change your nickname:</p>
            <input type="text" id="newNickname" placeholder="New Nickname">
            <button id="saveSettingsBtn">Save Changes</button>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, onAuthStateChanged, signOut, updateProfile } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getDatabase, ref, push, onChildAdded } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

        const firebaseConfig = {
            apiKey: "AIzaSyAF0IDQU21LWJ2Rggb7J0rY4F6UlvZaVZg",
            authDomain: "chatterbox-4b7dd.firebaseapp.com",
            databaseURL: "https://chatterbox-4b7dd-default-rtdb.firebaseio.com", 
            projectId: "chatterbox-4b7dd",
            storageBucket: "chatterbox-4b7dd.firebasestorage.app",
            messagingSenderId: "509263602746",
            appId: "1:509263602746:web:01051fc91ecb3bfa384103"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getDatabase(app);
        let isSignUp = false;

        // Navigation Logic
        const showSection = (id) => {
            document.getElementById('authSection').style.display = 'none';
            document.getElementById('chatSection').style.display = 'none';
            document.getElementById('settingsSection').style.display = 'none';
            document.getElementById(id).style.display = 'block';
        };

        document.getElementById('toSettingsBtn').onclick = () => showSection('settingsSection');
        document.getElementById('backToChatBtn').onclick = () => showSection('chatSection');

        // Toggle Auth Mode
        document.getElementById('toggleLink').onclick = () => {
            isSignUp = !isSignUp;
            document.getElementById('authTitle').innerText = isSignUp ? "Create Account" : "Chatter Box";
            document.getElementById('authBtn').innerText = isSignUp ? "Sign Up" : "Sign In";
            document.getElementById('nicknameBox').style.display = isSignUp ? "block" : "none";
        };

        // Auth Logic
        document.getElementById('authBtn').onclick = () => {
            const email = document.getElementById('email').value;
            const pass = document.getElementById('password').value;
            const nick = document.getElementById('nickname').value;
            
            if (isSignUp) {
                createUserWithEmailAndPassword(auth, email, pass)
                    .then((res) => updateProfile(res.user, { displayName: nick }))
                    .catch(e => alert(e.message));
            } else {
                signInWithEmailAndPassword(auth, email, pass).catch(e => alert(e.message));
            }
        };

        // Save New Nickname
        document.getElementById('saveSettingsBtn').onclick = () => {
            const newNick = document.getElementById('newNickname').value;
            if (newNick) {
                updateProfile(auth.currentUser, { displayName: newNick })
                    .then(() => {
                        alert("Nickname updated!");
                        showSection('chatSection');
                    })
                    .catch(e => alert(e.message));
            }
        };

        document.getElementById('logoutBtn').onclick = () => signOut(auth).then(() => location.reload());

        onAuthStateChanged(auth, (user) => {
            if (user) {
                showSection('chatSection');
                startChat(user);
            } else {
                showSection('authSection');
            }
        });

        function startChat(user) {
            const mRef = ref(db, 'messages');
            
            document.getElementById('sendBtn').onclick = () => {
                const text = document.getElementById('msgInput').value;
                if(text.trim()) {
                    push(mRef, { 
                        sender: auth.currentUser.displayName || user.email.split('@')[0], 
                        content: text, 
                        uid: user.uid 
                    });
                    document.getElementById('msgInput').value = "";
                }
            };

            // Clear window before adding messages to avoid duplicates
            document.getElementById('chatWindow').innerHTML = "";
            onChildAdded(mRef, (snap) => {
                const data = snap.val();
                const div = document.createElement('div');
                div.className = 'msg';
                div.innerHTML = `<strong>${data.sender}:</strong> ${data.content}`;
                document.getElementById('chatWindow').appendChild(div);
                document.getElementById('chatWindow').scrollTop = document.getElementById('chatWindow').scrollHeight;
            });
        }
    </script>
</body>
</html>
