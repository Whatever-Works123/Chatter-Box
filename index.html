<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chatter Box | Total Authority & Inbox Fix</title>
    <style>
        /* --- DESIGN SYSTEM --- */
        :root {
            --bg: #f0f2f5;
            --card: #ffffff;
            --sidebar-w: 280px;
            --text: #050505;
            --text-sub: #65676b;
            --accent: #0084ff;
            --orange: #FF8C42;
            --border: #e4e6eb;
            --me: #0084ff;
            --them: #e4e6eb;
            --online: #31a24c;
            --danger: #fa3e3e;
            --success: #42b72a;
        }

        body.dark {
            --bg: #18191a;
            --card: #242526;
            --text: #e4e6eb;
            --text-sub: #b0b3b8;
            --border: #3e4042;
            --them: #3a3b3c;
        }

        * { box-sizing: border-box; margin: 0; padding: 0; font-family: -apple-system, system-ui, sans-serif; }
        body { background: var(--bg); color: var(--text); height: 100vh; display: flex; overflow: hidden; }

        /* --- AUTHENTICATION --- */
        #auth-screen {
            position: fixed; inset: 0; background: var(--bg); z-index: 10000;
            display: flex; align-items: center; justify-content: center;
        }
        .auth-card {
            background: var(--card); width: 100%; max-width: 400px; padding: 40px;
            border-radius: 12px; box-shadow: 0 12px 28px rgba(0,0,0,0.1); text-align: center;
        }
        .logo { font-size: 34px; font-weight: 800; color: var(--orange); font-style: italic; margin-bottom: 30px; }
        input { width: 100%; padding: 14px; margin-bottom: 15px; border-radius: 8px; border: 1px solid var(--border); background: var(--bg); color: var(--text); }
        .btn { width: 100%; padding: 14px; background: var(--accent); color: white; border: none; border-radius: 8px; font-weight: bold; cursor: pointer; }
        .btn:hover { opacity: 0.9; }

        /* --- LAYOUT --- */
        .sidebar {
            width: var(--sidebar-w); background: var(--card); border-right: 1px solid var(--border);
            display: none; flex-direction: column; padding: 20px;
        }
        .nav-link {
            padding: 12px 15px; border-radius: 8px; color: var(--text-sub); font-weight: 600;
            cursor: pointer; display: flex; align-items: center; margin-bottom: 5px;
        }
        .nav-link:hover { background: rgba(0,0,0,0.05); }
        .nav-link.active { background: rgba(0,132,255,0.1); color: var(--accent); }
        .badge { background: var(--danger); color: white; font-size: 10px; padding: 2px 8px; border-radius: 10px; margin-left: auto; }

        .viewport { flex: 1; display: flex; flex-direction: column; padding: 20px; overflow-y: auto; }
        .main-container {
            width: 100%; max-width: 900px; margin: 0 auto; background: var(--card);
            border-radius: 16px; border: 1px solid var(--border); min-height: 85vh; display: flex; flex-direction: column;
        }
        .view-head { padding: 20px 30px; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; }
        .view-body { padding: 20px; flex: 1; }
        .page { display: none; }
        .page.active { display: block; animation: fadeIn 0.3s; }

        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

        /* --- COMPONENTS --- */
        .row { display: flex; align-items: center; padding: 15px; border-bottom: 1px solid var(--border); cursor: pointer; border-radius: 10px; }
        .row:hover { background: rgba(0,0,0,0.02); }
        .avatar {
            width: 45px; height: 45px; border-radius: 50%; background: #ccc; margin-right: 15px;
            display: flex; align-items: center; justify-content: center; color: white; font-weight: bold; position: relative; flex-shrink: 0;
        }
        .avatar.online::after {
            content: ''; position: absolute; bottom: 2px; right: 2px; width: 11px; height: 11px;
            background: var(--online); border: 2px solid var(--card); border-radius: 50%;
        }

        /* --- CHAT --- */
        #chat-panel {
            position: fixed; top: 0; right: -100%; width: 100%; max-width: 500px; height: 100%;
            background: var(--card); border-left: 1px solid var(--border); z-index: 9000;
            transition: 0.4s cubic-bezier(0.4, 0, 0.2, 1); display: flex; flex-direction: column;
            box-shadow: -10px 0 30px rgba(0,0,0,0.05);
        }
        #chat-panel.active { right: 0; }
        .chat-messages { flex: 1; padding: 20px; background: var(--bg); overflow-y: auto; display: flex; flex-direction: column; gap: 10px; }
        .bubble { padding: 10px 16px; border-radius: 18px; font-size: 14px; max-width: 80%; word-wrap: break-word; }
        .bubble.me { align-self: flex-end; background: var(--me); color: white; border-bottom-right-radius: 4px; }
        .bubble.them { align-self: flex-start; background: var(--them); color: var(--text); border-bottom-left-radius: 4px; }
        .chat-input { padding: 15px 20px; border-top: 1px solid var(--border); display: flex; gap: 10px; }

        /* --- REQUESTS --- */
        .req-card { background: var(--bg); border: 1px solid var(--border); padding: 15px; border-radius: 10px; margin-bottom: 10px; }
        .btn-s { padding: 6px 12px; font-size: 12px; border-radius: 6px; margin-right: 5px; }
        .btn-ok { background: var(--success); color: white; }
        .btn-no { background: var(--danger); color: white; }
    </style>
</head>
<body class="">

    <div id="auth-screen">
        <div class="auth-card">
            <div class="logo">Chatter Box</div>
            <div id="login-view">
                <input type="email" id="email-in" placeholder="Email">
                <input type="password" id="pass-in" placeholder="Password">
                <button class="btn" onclick="sys.login()">Login</button>
                <p onclick="sys.swapAuth(false)" style="margin-top:20px; color:var(--accent); cursor:pointer">Create Account</p>
            </div>
            <div id="reg-view" style="display:none">
                <input type="text" id="name-reg" placeholder="Full Name">
                <input type="email" id="email-reg" placeholder="Email">
                <input type="password" id="pass-reg" placeholder="Password">
                <button class="btn" onclick="sys.register()">Sign Up</button>
                <p onclick="sys.swapAuth(true)" style="margin-top:20px; color:var(--accent); cursor:pointer">Already a member?</p>
            </div>
            <p id="auth-err" style="color:red; font-size:12px; margin-top:15px"></p>
        </div>
    </div>

    <nav class="sidebar" id="sidebar">
        <div class="logo" style="font-size:24px; margin-bottom:40px">Chatter Box</div>
        <div class="nav-link active" id="n-inbox" onclick="sys.go('inbox')">üè† Inbox</div>
        <div class="nav-link" id="n-groups" onclick="sys.go('groups')">üë• My Groups</div>
        <div class="nav-link" id="n-reqs" onclick="sys.go('reqs')">üõ°Ô∏è Approvals <span id="req-badge" class="badge" style="display:none">0</span></div>
        <div class="nav-link" id="n-search" onclick="sys.go('search')">üîç Search</div>
        <div class="nav-link" id="n-settings" onclick="sys.go('settings')">‚öôÔ∏è Settings</div>
        <button class="btn" style="background:var(--danger); margin-top:auto" onclick="sys.logout()">Logout</button>
    </nav>

    <main class="viewport">
        <div class="main-container">
            <div id="p-inbox" class="page active">
                <div class="view-head"><h2>Recent Messages</h2></div>
                <div id="list-inbox" class="view-body"></div>
            </div>

            <div id="p-groups" class="page">
                <div class="view-head">
                    <h2>Groups</h2>
                    <button class="btn" style="width:auto; padding:8px 15px" onclick="sys.makeGroup()">+ New Group</button>
                </div>
                <div id="list-groups" class="view-body"></div>
            </div>

            <div id="p-reqs" class="page">
                <div class="view-head"><h2>Member Approvals</h2></div>
                <div id="list-reqs" class="view-body"></div>
            </div>

            <div id="p-search" class="page">
                <div class="view-head"><h2>Search People</h2></div>
                <div class="view-body">
                    <input type="text" placeholder="Start typing a name..." oninput="sys.search(this.value)">
                    <div id="list-search"></div>
                </div>
            </div>

            <div id="p-settings" class="page">
                <div class="view-head"><h2>Settings</h2></div>
                <div class="view-body">
                    <button class="btn" style="width:auto; padding:10px 20px" onclick="document.body.classList.toggle('dark')">üåì Toggle Dark Mode</button>
                </div>
            </div>
        </div>
    </main>

    <div id="chat-panel">
        <div class="view-head">
            <button onclick="sys.closeChat()" style="background:none; border:none; font-size:24px; cursor:pointer">‚Üê</button>
            <div id="c-avatar" class="avatar"></div>
            <div style="flex:1">
                <b id="c-name">User</b><br>
                <small id="c-sub" style="font-size:10px; color:var(--text-sub)"></small>
            </div>
            <div id="c-tools" style="display:flex; gap:5px">
                <button class="btn-s btn-ok" id="btn-add" style="display:none" onclick="sys.invitePrompt()">+ Invite</button>
                <button class="btn-s btn-no" id="btn-exit" style="display:none" onclick="sys.leaveGroup()">Leave</button>
            </div>
        </div>
        <div id="c-feed" class="chat-messages"></div>
        <div class="chat-input">
            <input type="text" id="c-input" style="margin:0; border-radius:25px" placeholder="Type message...">
            <button class="btn" style="width:80px; border-radius:25px" onclick="sys.send()">Send</button>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, onAuthStateChanged, signInWithEmailAndPassword, createUserWithEmailAndPassword, signOut } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getDatabase, ref, set, push, onValue, get, update, remove, onDisconnect } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

        const config = { apiKey: "AIzaSyAF0IDQU21LWJ2Rggb7J0rY4F6UlvZaVZg", authDomain: "chatterbox-4b7dd.firebaseapp.com", databaseURL: "https://chatterbox-4b7dd-default-rtdb.firebaseio.com", projectId: "chatterbox-4b7dd" };
        const app = initializeApp(config);
        const auth = getAuth(app);
        const db = getDatabase(app);

        let me = null;
        let myName = "";
        let activeId = null;
        let activeType = null;

        const sys = {
            swapAuth: (isL) => {
                document.getElementById('login-view').style.display = isL ? 'block' : 'none';
                document.getElementById('reg-view').style.display = isL ? 'none' : 'block';
            },
            login: () => signInWithEmailAndPassword(auth, document.getElementById('email-in').value, document.getElementById('pass-in').value).catch(e => document.getElementById('auth-err').innerText = e.message),
            register: () => {
                const n = document.getElementById('name-reg').value;
                if(!n) return alert("Name required");
                createUserWithEmailAndPassword(auth, document.getElementById('email-reg').value, document.getElementById('pass-reg').value).then(res => {
                    set(ref(db, `users/${res.user.uid}`), { name: n, status: 'online', uid: res.user.uid });
                }).catch(e => document.getElementById('auth-err').innerText = e.message);
            },
            logout: () => signOut(auth).then(() => location.reload()),
            go: (id) => {
                document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
                document.getElementById('p-' + id).classList.add('active');
                document.querySelectorAll('.nav-link').forEach(n => n.classList.remove('active'));
                document.getElementById('n-' + id).classList.add('active');
                sys.closeChat();
            },

            // --- INBOX ENGINE (FIXED) ---
            loadInbox: () => {
                const list = document.getElementById('list-inbox');
                onValue(ref(db, `users/${me.uid}/chats`), async (snap) => {
                    list.innerHTML = "";
                    if (!snap.exists()) {
                        list.innerHTML = "<p style='text-align:center; color:gray; padding-top:50px'>No chats yet.</p>";
                        return;
                    }

                    // Create a prioritized list of chat data
                    const entries = [];
                    snap.forEach(child => { entries.push({ id: child.key, meta: child.val() }); });
                    entries.sort((a, b) => b.meta.time - a.meta.time);

                    for (let entry of entries) {
                        const path = entry.meta.type === 'group' ? `groups/${entry.id}` : `users/${entry.id}`;
                        const detailSnap = await get(ref(db, path));
                        
                        if (detailSnap.exists()) {
                            const data = detailSnap.val();
                            const row = document.createElement('div');
                            row.className = "row";
                            const online = entry.meta.type === 'private' && data.status === 'online';
                            row.innerHTML = `
                                <div class="avatar ${online ? 'online' : ''}">${data.name[0]}</div>
                                <div style="flex:1"><b>${data.name}</b><br><small style="color:var(--text-sub)">${entry.meta.last || ''}</small></div>
                            `;
                            row.onclick = () => sys.openChat(entry.id, data.name, entry.meta.type);
                            list.appendChild(row);
                        }
                    }
                });
            },

            // --- GROUP LOGIC ---
            makeGroup: async () => {
                const n = prompt("Group Name:");
                if (!n) return;
                const gRef = push(ref(db, 'groups'));
                const gId = gRef.key;
                await set(gRef, { id: gId, name: n, owner: me.uid, ownerName: myName, members: { [me.uid]: true } });
                update(ref(db, `users/${me.uid}/chats/${gId}`), { type: 'group', last: 'You created the group', time: Date.now() });
                sys.go('groups');
            },

            invitePrompt: async () => {
                const target = prompt("Type the user's Full Name exactly:");
                if (!target) return;
                const users = await get(ref(db, 'users'));
                let foundId = null;
                users.forEach(u => { if (u.val().name === target) foundId = u.key; });

                if (!foundId) return alert("User not found.");
                
                const gSnap = await get(ref(db, `groups/${activeId}`));
                const g = gSnap.val();

                if (g.owner === me.uid) {
                    sys.forceAdd(activeId, foundId, g.name);
                } else {
                    push(ref(db, `requests/${g.owner}`), {
                        gid: activeId, gname: g.name, tid: foundId, tname: target, fid: me.uid, fname: myName, time: Date.now()
                    });
                    alert("Request sent to owner for approval.");
                }
            },

            forceAdd: (gid, uid, gname) => {
                update(ref(db, `groups/${gid}/members/${uid}`), true);
                update(ref(db, `users/${uid}/chats/${gid}`), { type: 'group', last: 'You were added!', time: Date.now() });
                alert("Member added.");
            },

            loadReqs: () => {
                onValue(ref(db, `requests/${me.uid}`), snap => {
                    const list = document.getElementById('list-reqs');
                    const badge = document.getElementById('req-badge');
                    list.innerHTML = "";
                    let count = 0;
                    snap.forEach(child => {
                        count++;
                        const r = child.val();
                        const div = document.createElement('div');
                        div.className = "req-card";
                        div.innerHTML = `
                            <p><b>${r.fname}</b> wants to add <b>${r.tname}</b> to <b>${r.gname}</b></p>
                            <div style="margin-top:10px">
                                <button class="btn-s btn-ok" onclick="sys.handleReq('${child.key}', true, '${r.tid}', '${r.gid}', '${r.gname}')">Approve</button>
                                <button class="btn-s btn-no" onclick="sys.handleReq('${child.key}', false)">Deny</button>
                            </div>
                        `;
                        list.appendChild(div);
                    });
                    badge.innerText = count;
                    badge.style.display = count > 0 ? 'block' : 'none';
                });
            },

            handleReq: (rid, ok, tid, gid, gname) => {
                if (ok) sys.forceAdd(gid, tid, gname);
                remove(ref(db, `requests/${me.uid}/${rid}`));
            },

            leaveGroup: async () => {
                if(!confirm("Leave group?")) return;
                await remove(ref(db, `groups/${activeId}/members/${me.uid}`));
                await remove(ref(db, `users/${me.uid}/chats/${activeId}`));
                sys.closeChat();
            },

            // --- CHAT ENGINE ---
            openChat: (id, name, type) => {
                activeId = id; activeType = type;
                document.getElementById('chat-panel').classList.add('active');
                document.getElementById('c-name').innerText = name;
                document.getElementById('c-avatar').innerText = name[0];
                document.getElementById('c-sub').innerText = type === 'group' ? 'Private Group' : 'Direct Message';
                
                document.getElementById('btn-add').style.display = type === 'group' ? 'block' : 'none';
                document.getElementById('btn-exit').style.display = type === 'group' ? 'block' : 'none';

                const path = type === 'group' ? id : [me.uid, id].sort().join('_');
                onValue(ref(db, `messages/${path}`), snap => {
                    const feed = document.getElementById('c-feed'); feed.innerHTML = "";
                    snap.forEach(m => {
                        const d = m.val();
                        const b = document.createElement('div');
                        b.className = `bubble ${d.sid === me.uid ? 'me' : 'them'}`;
                        b.innerHTML = (type === 'group' && d.sid !== me.uid ? `<small style="display:block;font-size:9px">${d.sname}</small>` : '') + d.txt;
                        feed.appendChild(b);
                    });
                    feed.scrollTop = feed.scrollHeight;
                });
            },

            closeChat: () => { document.getElementById('chat-panel').classList.remove('active'); activeId = null; },

            send: () => {
                const val = document.getElementById('c-input').value.trim();
                if (!val || !activeId) return;
                const path = activeType === 'group' ? activeId : [me.uid, activeId].sort().join('_');
                const now = Date.now();
                push(ref(db, `messages/${path}`), { sid: me.uid, sname: myName, txt: val, time: now });

                if (activeType === 'private') {
                    update(ref(db, `users/${me.uid}/chats/${activeId}`), { type: 'private', last: val, time: now });
                    update(ref(db, `users/${activeId}/chats/${me.uid}`), { name: myName, type: 'private', last: val, time: now });
                } else {
                    get(ref(db, `groups/${activeId}/members`)).then(mems => {
                        mems.forEach(m => { update(ref(db, `users/${m.key}/chats/${activeId}`), { type: 'group', last: `${myName}: ${val}`, time: now }); });
                    });
                }
                document.getElementById('c-input').value = "";
            },

            search: (q) => {
                const out = document.getElementById('list-search'); if (!q) return out.innerHTML = "";
                get(ref(db, 'users')).then(snap => {
                    out.innerHTML = "";
                    snap.forEach(u => {
                        if (u.val().name.toLowerCase().includes(q.toLowerCase()) && u.key !== me.uid) {
                            const d = u.val();
                            const div = document.createElement('div'); div.className = "row";
                            div.innerHTML = `<div class="avatar">${d.name[0]}</div><b>${d.name}</b>`;
                            div.onclick = () => sys.openChat(u.key, d.name, 'private');
                            out.appendChild(div);
                        }
                    });
                });
            }
        };

        onAuthStateChanged(auth, u => {
            if (u) {
                me = u;
                document.getElementById('auth-screen').style.display = 'none';
                document.getElementById('sidebar').style.display = 'flex';
                onValue(ref(db, `users/${u.uid}`), snap => {
                    myName = snap.val().name;
                    sys.loadInbox(); sys.loadReqs();
                });
                const sRef = ref(db, `users/${u.uid}/status`);
                set(sRef, 'online'); onDisconnect(sRef).set('offline');
            } else {
                document.getElementById('auth-screen').style.display = 'flex';
            }
        });

        window.sys = sys;
    </script>
</body>
</html>
