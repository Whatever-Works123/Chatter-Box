<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chatter Box | Messaging Fixed</title>
    <style>
        * { box-sizing: border-box; outline: none; }
        :root { 
            --bg: #f0f2f5; --side: #ffffff; --text: #1c1e21; --accent: #0084ff; 
            --border: #e4e6eb; --card: #ffffff; --msg-them: #e4e6eb;
        }
        body.dark { 
            --bg: #18191a; --side: #242526; --text: #e4e6eb; --accent: #2e89ff; 
            --border: #3e4042; --card: #242526; --msg-them: #3a3b3c;
        }
        
        body { font-family: 'Segoe UI', sans-serif; margin: 0; display: flex; height: 100vh; background: var(--bg); color: var(--text); overflow: hidden; }
        
        /* AUTH */
        #auth-screen { position: fixed; inset: 0; background: var(--bg); z-index: 9999; display: flex; justify-content: center; align-items: center; }
        .auth-box { background: var(--card); padding: 40px; border-radius: 20px; text-align: center; width: 400px; box-shadow: 0 15px 35px rgba(0,0,0,0.1); border: 1px solid var(--border); }
        .auth-toggle { margin-top: 15px; font-size: 14px; cursor: pointer; color: var(--accent); font-weight: 600; }

        /* SIDEBAR */
        .sidebar { width: 300px; background: var(--side); border-right: 1px solid var(--border); display: none; flex-direction: column; padding: 25px; flex-shrink: 0; }
        .app-logo { font-size: 28px; font-weight: 800; color: #FF8C42; margin-bottom: 40px; font-style: italic; }
        .menu-item { display: flex; align-items: center; gap: 15px; padding: 14px; border-radius: 12px; cursor: pointer; margin-bottom: 8px; font-weight: 600; color: #65676b; position: relative; }
        .menu-item.active { background: rgba(0, 132, 255, 0.1); color: var(--accent); }
        .notif-dot { display: none; width: 10px; height: 10px; background: #ff4d4d; border-radius: 50%; position: absolute; right: 15px; top: 50%; transform: translateY(-50%); border: 2px solid var(--side); }

        /* VIEWPORT */
        .main-viewport { flex: 1; display: flex; justify-content: center; overflow-y: auto; padding: 20px; }
        .content-container { width: 100%; max-width: 800px; background: var(--card); border-radius: 16px; border: 1px solid var(--border); min-height: 92vh; position: relative; }
        .page { display: none; padding: 20px; }
        .page-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; padding-bottom: 15px; border-bottom: 1px solid var(--border); }

        /* CHAT WINDOW */
        #chat-window { position: fixed; top: 0; right: -500px; bottom: 0; width: 450px; background: var(--card); border-left: 1px solid var(--border); transition: 0.4s cubic-bezier(0.18, 0.89, 0.32, 1.1); z-index: 1000; display: flex; flex-direction: column; box-shadow: -10px 0 30px rgba(0,0,0,0.1); }
        #chat-window.open { right: 0; }
        .chat-msgs { flex: 1; padding: 20px; overflow-y: auto; display: flex; flex-direction: column; gap: 12px; background: var(--bg); }
        
        .msg-container { display: flex; flex-direction: column; max-width: 80%; }
        .bubble { padding: 12px 16px; border-radius: 18px; font-size: 14.5px; line-height: 1.4; box-shadow: 0 1px 2px rgba(0,0,0,0.1); }

        /* UI ELEMENTS */
        .avatar { width: 45px; height: 45px; border-radius: 50%; background-size: cover; background-position: center; background-color: #ccd0d5; display: flex; align-items: center; justify-content: center; color: white; font-weight: bold; flex-shrink: 0; }
        .avatar.group { border-radius: 12px; background: #FF8C42; }
        input { width: 100%; padding: 14px; margin-bottom: 12px; border: 1px solid var(--border); border-radius: 10px; background: var(--bg); color: var(--text); }
        .btn { background: var(--accent); color: white; border: none; padding: 12px 20px; border-radius: 10px; font-weight: 700; cursor: pointer; transition: 0.2s; }
        
        .list-item { display: flex; align-items: center; padding: 12px; cursor: pointer; border-radius: 12px; margin-bottom: 5px; transition: 0.2s; }
        .list-item:hover { background: rgba(0,0,0,0.03); }
        .list-item b { margin-left: 15px; font-size: 16px; flex: 1; }
        .list-item.unread { border-left: 4px solid var(--accent); background: rgba(0, 132, 255, 0.05); }
    </style>
</head>
<body>

    <div id="auth-screen">
        <div class="auth-box">
            <h1>Chatter Box</h1>
            <div id="login-form">
                <input type="email" id="login-email" placeholder="Email">
                <input type="password" id="login-pass" placeholder="Password">
                <button class="btn" id="btn-do-login" style="width:100%">Log In</button>
                <div class="auth-toggle" onclick="toggleAuth(false)">New here? Sign up</div>
            </div>
            <div id="signup-form" style="display:none">
                <input type="text" id="signup-name" placeholder="Display Name">
                <input type="email" id="signup-email" placeholder="Email">
                <input type="password" id="signup-pass" placeholder="Create Password">
                <button class="btn" id="btn-do-signup" style="width:100%">Create Account</button>
                <div class="auth-toggle" onclick="toggleAuth(true)">Already have an account? Log in</div>
            </div>
            <p id="auth-err" style="color:#ff4d4d; font-size:12px; margin-top:10px;"></p>
        </div>
    </div>

    <div id="side-menu" class="sidebar">
        <div class="app-logo">Chatter Box</div>
        <div class="menu-item active" onclick="nav('home-page', this)">üè† Home <div id="home-dot" class="notif-dot"></div></div>
        <div class="menu-item" onclick="nav('search-page', this)">üîç Search</div>
        <div class="menu-item" onclick="nav('profile-page', this)">üë§ Profile</div>
        <div class="menu-item" onclick="nav('settings-page', this)">‚öôÔ∏è Settings</div>
        <div style="margin-top:auto" class="menu-item" id="btn-logout"><span style="color:#ff4d4d;">üö™ Logout</span></div>
    </div>

    <div class="main-viewport">
        <div class="content-container">
            <div id="home-page" class="page" style="display:block;"><div class="page-header"><h2>Messages</h2></div><div id="inbox-list"></div></div>
            <div id="search-page" class="page">
                <div class="page-header"><h2>Find People</h2><button class="btn" style="padding:6px 12px; font-size:12px" onclick="createGroup()">+ New Group</button></div>
                <input type="text" id="s-query" placeholder="Type a name to search...">
                <div id="s-results"></div>
            </div>
            <div id="profile-page" class="page"><div class="page-header"><h2>Profile</h2></div><div id="p-data" style="text-align:center"></div></div>
            <div id="settings-page" class="page"><div class="page-header"><h2>Settings</h2></div><button class="btn" onclick="document.body.classList.toggle('dark')">Toggle Dark Mode</button></div>
        </div>
    </div>

    <div id="chat-window">
        <div style="padding:15px; border-bottom:1px solid var(--border); display:flex; align-items:center; gap:12px">
            <button onclick="closeChat()" style="background:none; border:none; font-size:24px; cursor:pointer">√ó</button>
            <div id="chat-pfp" class="avatar" style="width:35px; height:35px"></div>
            <b id="chat-user-name" style="flex:1"></b>
        </div>
        <div id="chat-msgs" class="chat-msgs"></div>
        <div style="padding:20px; border-top:1px solid var(--border); display:flex; gap:10px; background:var(--card)">
            <input type="text" id="chat-input" placeholder="Write a message..." style="margin:0; border-radius:20px">
            <button class="btn" id="btn-send" style="width:auto">Send</button>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, onAuthStateChanged, signInWithEmailAndPassword, createUserWithEmailAndPassword, signOut } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getDatabase, ref, set, push, onValue, get, update, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

        const config = { apiKey: "AIzaSyAF0IDQU21LWJ2Rggb7J0rY4F6UlvZaVZg", authDomain: "chatterbox-4b7dd.firebaseapp.com", databaseURL: "https://chatterbox-4b7dd-default-rtdb.firebaseio.com", projectId: "chatterbox-4b7dd" };
        const app = initializeApp(config);
        const auth = getAuth(app);
        const db = getDatabase(app);
        
        let activePeer = null, isGroup = false, userNames = {};

        // --- AUTH ---
        window.toggleAuth = (isLogin) => {
            document.getElementById('login-form').style.display = isLogin ? 'block' : 'none';
            document.getElementById('signup-form').style.display = isLogin ? 'none' : 'block';
        };

        document.getElementById('btn-do-login').onclick = () => {
            signInWithEmailAndPassword(auth, document.getElementById('login-email').value, document.getElementById('login-pass').value)
            .catch(e => document.getElementById('auth-err').innerText = e.message);
        };

        document.getElementById('btn-do-signup').onclick = () => {
            const n = document.getElementById('signup-name').value;
            createUserWithEmailAndPassword(auth, document.getElementById('signup-email').value, document.getElementById('signup-pass').value)
            .then(res => set(ref(db, 'users/' + res.user.uid), { name: n, pfp: "", bio: "Hello!" }))
            .catch(e => document.getElementById('auth-err').innerText = e.message);
        };

        document.getElementById('btn-logout').onclick = () => signOut(auth).then(() => location.reload());

        onAuthStateChanged(auth, u => {
            if(u) {
                document.getElementById('auth-screen').style.display = 'none';
                document.getElementById('side-menu').style.display = 'flex';
                initApp();
            }
        });

        // --- CORE APP ---
        function initApp() {
            onValue(ref(db, 'users'), snap => snap.forEach(u => userNames[u.key] = u.val().name));

            // Inbox Listener
            onValue(ref(db, `users/${auth.currentUser.uid}/chats`), snap => {
                const list = document.getElementById('inbox-list'); list.innerHTML = "";
                let alertMe = false;
                snap.forEach(c => {
                    const info = c.val(); if(info.unread) alertMe = true;
                    const path = info.type === 'group' ? `groups/${c.key}` : `users/${c.key}`;
                    get(ref(db, path)).then(s => {
                        const d = s.val(); if(!d) return;
                        const item = document.createElement('div');
                        item.className = `list-item ${info.unread ? 'unread' : ''}`;
                        item.innerHTML = `<div class="avatar ${info.type==='group'?'group':''}"></div><b>${d.name}</b>`;
                        item.onclick = () => openChat(c.key, d.name, info.type === 'group');
                        list.appendChild(item);
                    });
                });
                document.getElementById('home-dot').style.display = alertMe ? 'block' : 'none';
            });
        }

        window.openChat = (id, name, isGrp) => {
            activePeer = id; isGroup = isGrp;
            document.getElementById('chat-window').classList.add('open');
            document.getElementById('chat-user-name').innerText = name;
            update(ref(db, `users/${auth.currentUser.uid}/chats/${id}`), { unread: false });
            
            const chatId = isGrp ? id : [auth.currentUser.uid, id].sort().join('_');
            onValue(ref(db, 'messages/' + chatId), snap => {
                const box = document.getElementById('chat-msgs'); box.innerHTML = "";
                snap.forEach(m => {
                    const d = m.val(); const side = d.sender === auth.currentUser.uid ? 'flex-end' : 'flex-start';
                    box.insertAdjacentHTML('beforeend', `
                        <div class="msg-container" style="align-self:${side}">
                            <div class="bubble" style="background:${side==='flex-end'?'var(--accent)':'var(--msg-them)'}; color:${side==='flex-end'?'white':'black'}">${d.text}</div>
                        </div>`);
                });
                box.scrollTop = box.scrollHeight;
            });
        };

        // FIXED MESSAGING LOGIC
        document.getElementById('btn-send').onclick = () => {
            const txt = document.getElementById('chat-input').value.trim(); if(!txt || !activePeer) return;
            const chatId = isGroup ? activePeer : [auth.currentUser.uid, activePeer].sort().join('_');
            
            // 1. Push the message
            push(ref(db, 'messages/' + chatId), { sender: auth.currentUser.uid, text: txt, time: serverTimestamp() });
            
            // 2. Update Sender's Inbox
            update(ref(db, `users/${auth.currentUser.uid}/chats/${activePeer}`), { lastTime: Date.now(), type: isGroup ? 'group' : 'personal', unread: false });
            
            // 3. Update Receiver's Inbox (Crucial Fix)
            if(!isGroup) {
                update(ref(db, `users/${activePeer}/chats/${auth.currentUser.uid}`), { 
                    lastTime: Date.now(), 
                    type: 'personal', 
                    unread: true 
                });
            } else {
                // For Groups: Update everyone in the group (simplified logic)
                get(ref(db, `groups/${activePeer}/members`)).then(snap => {
                    snap.forEach(m => {
                        if(m.key !== auth.currentUser.uid) {
                            update(ref(db, `users/${m.key}/chats/${activePeer}`), { lastTime: Date.now(), unread: true });
                        }
                    });
                });
            }
            
            document.getElementById('chat-input').value = "";
        };

        window.createGroup = () => {
            const n = prompt("Group Name:"); if(!n) return;
            const gRef = push(ref(db, 'groups'));
            set(gRef, { name: n, creator: auth.currentUser.uid });
            update(ref(db, `users/${auth.currentUser.uid}/chats/${gRef.key}`), { type: 'group', lastTime: Date.now() });
        };

        window.nav = (id, el) => {
            document.querySelectorAll('.page').forEach(p => p.style.display = 'none');
            document.getElementById(id).style.display = 'block';
            document.querySelectorAll('.menu-item').forEach(m => m.classList.remove('active'));
            el.classList.add('active');
            closeChat();
        };

        window.closeChat = () => document.getElementById('chat-window').classList.remove('open');

        // Global Search
        document.getElementById('s-query').oninput = (e) => {
            const q = e.target.value.toLowerCase(), res = document.getElementById('s-results');
            res.innerHTML = ""; if(!q) return;
            get(ref(db, 'users')).then(snap => snap.forEach(c => {
                if(c.val().name.toLowerCase().includes(q) && c.key !== auth.currentUser.uid) {
                    const div = document.createElement('div'); div.className = 'list-item';
                    div.innerHTML = `<div class="avatar"></div><b>${c.val().name}</b>`;
                    div.onclick = () => openChat(c.key, c.val().name, false);
                    res.appendChild(div);
                }
            }));
        };
    </script>
</body>
</html>
