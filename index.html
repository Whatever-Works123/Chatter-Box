<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chatter Box</title>
    <style>
        body { font-family: 'Inter', sans-serif; background: #0f0c29; color: white; display: flex; justify-content: center; align-items: center; height: 100vh; margin: 0; }
        .app-container { width: 95%; max-width: 450px; height: 85vh; background: rgba(255, 255, 255, 0.05); border-radius: 24px; border: 1px solid rgba(255, 255, 255, 0.1); display: flex; flex-direction: column; overflow: hidden; box-shadow: 0 20px 50px rgba(0,0,0,0.5); }
        #authSection { padding: 40px; text-align: center; display: flex; flex-direction: column; justify-content: center; height: 100%; }
        #chatSection { display: none; flex-direction: column; height: 100%; }
        .header { padding: 15px; background: rgba(255, 255, 255, 0.1); text-align: center; font-weight: bold; }
        .message-box { flex: 1; padding: 20px; overflow-y: auto; display: flex; flex-direction: column; gap: 12px; }
        .bubble { padding: 12px; border-radius: 15px; max-width: 80%; word-wrap: break-word; }
        .my-msg { align-self: flex-end; background: #2575fc; }
        .friend-msg { align-self: flex-start; background: #333; }
        input { background: rgba(255, 255, 255, 0.1); border: 1px solid rgba(255, 255, 255, 0.2); padding: 12px; border-radius: 12px; color: white; margin-bottom: 10px; outline: none; }
        button { background: #2575fc; color: white; border: none; padding: 12px; border-radius: 12px; cursor: pointer; font-weight: bold; margin-bottom: 5px; }
        .switch-text { font-size: 12px; cursor: pointer; color: #2575fc; margin-top: 10px; }
    </style>
</head>
<body>

    <div class="app-container">
        <div id="authSection">
            <h1 id="authTitle">Sign In</h1>
            <input type="email" id="emailInput" placeholder="Email (e.g. name@mail.com)">
            <input type="password" id="passInput" placeholder="Password">
            <button id="authBtn" onclick="handleAuth()">Sign In</button>
            <p class="switch-text" id="toggleLink" onclick="toggleAuth()">Don't have an account? Sign Up</p>
        </div>

        <div id="chatSection">
            <div class="header">Chatter Box</div>
            <div class="message-box" id="chatWindow"></div>
            <div style="padding: 15px; display: flex; gap: 5px;">
                <input type="text" id="msgInput" placeholder="Message..." style="flex:1;">
                <button onclick="sendMsg()" style="margin:0;">Send</button>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getDatabase, ref, push, onChildAdded } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

        const firebaseConfig = {
            apiKey: "AIzaSyAF0IDQU21LWJ2Rggb7J0rY4F6UlvZaVZg",
            authDomain: "chatterbox-4b7dd.firebaseapp.com",
            projectId: "chatterbox-4b7dd",
            storageBucket: "chatterbox-4b7dd.firebasestorage.app",
            messagingSenderId: "509263602746",
            appId: "1:509263602746:web:01051fc91ecb3bfa384103",
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getDatabase(app);
        let isSigningUp = false;

        // Toggle between Login and Sign Up UI
        window.toggleAuth = function() {
            isSigningUp = !isSigningUp;
            document.getElementById('authTitle').innerText = isSigningUp ? "Sign Up" : "Sign In";
            document.getElementById('authBtn').innerText = isSigningUp ? "Create Account" : "Sign In";
            document.getElementById('toggleLink').innerText = isSigningUp ? "Already have an account? Sign In" : "Don't have an account? Sign Up";
        }

        // Handle the Actual Sign Up / Sign In
        window.handleAuth = function() {
            const email = document.getElementById('emailInput').value;
            const pass = document.getElementById('passInput').value;
            
            if (isSigningUp) {
                createUserWithEmailAndPassword(auth, email, pass).catch(err => alert(err.message));
            } else {
                signInWithEmailAndPassword(auth, email, pass).catch(err => alert(err.message));
            }
        }

        // Detect if user is logged in
        onAuthStateChanged(auth, (user) => {
            if (user) {
                document.getElementById('authSection').style.display = 'none';
                document.getElementById('chatSection').style.display = 'flex';
                startChat(user.email);
            }
        });

        function startChat(userEmail) {
            const messagesRef = ref(db, 'messages');
            
            window.sendMsg = function() {
                const text = document.getElementById('msgInput').value;
                if (text.trim() !== "") {
                    push(messagesRef, { name: userEmail, text: text });
                    document.getElementById('msgInput').value = "";
                }
            };

            onChildAdded(messagesRef, (snap) => {
                const data = snap.val();
                const div = document.createElement('div');
                div.className = data.name === userEmail ? 'bubble my-msg' : 'bubble friend-msg';
                div.innerHTML = `<strong>${data.name.split('@')[0]}:</strong> ${data.text}`;
                document.getElementById('chatWindow').appendChild(div);
                document.getElementById('chatWindow').scrollTop = document.getElementById('chatWindow').scrollHeight;
            });
        }
    </script>
</body>
</html>
