<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chatter Box | Fixed Everything</title>
    <style>
        * { box-sizing: border-box; }
        body { font-family: sans-serif; margin: 0; display: flex; height: 100vh; overflow: hidden; background: #fafafa; }
        .sidebar { width: 240px; border-right: 1px solid #dbdbdb; padding: 20px; background: #fff; display: flex; flex-direction: column; }
        .nav-item { padding: 12px; cursor: pointer; border-radius: 8px; margin-bottom: 5px; }
        .nav-item:hover { background: #f0f0f0; }
        .nav-item.active { font-weight: bold; }
        .main { flex: 1; overflow-y: auto; display: flex; justify-content: center; }
        .content { width: 100%; max-width: 600px; padding: 20px; }

        /* STORIES */
        .story-bar { display: flex; gap: 15px; overflow-x: auto; padding: 15px; background: #fff; border: 1px solid #dbdbdb; border-radius: 8px; margin-bottom: 20px; }
        .story-circle { min-width: 65px; text-align: center; cursor: pointer; }
        .ring { width: 60px; height: 60px; border-radius: 50%; padding: 2px; background: linear-gradient(45deg, #f09433, #dc2743, #bc1888); margin: 0 auto; }
        .pfp { width: 100%; height: 100%; border-radius: 50%; border: 2px solid #fff; background-size: cover; background-position: center; background-color: #eee; position: relative; }
        .plus { position: absolute; bottom: 0; right: 0; background: #0095f6; color: #fff; border-radius: 50%; width: 15px; height: 15px; font-size: 10px; border: 1px solid #fff; }

        /* SEARCH */
        .user-row { display: flex; align-items: center; padding: 10px; background: #fff; border: 1px solid #dbdbdb; margin-bottom: 5px; border-radius: 8px; }
        .btn { margin-left: auto; background: #0095f6; color: #fff; border: none; padding: 6px 12px; border-radius: 4px; cursor: pointer; }
        .btn.following { background: #efefef; color: #000; }

        /* VIEWER */
        #viewer { display: none; position: fixed; inset: 0; background: #000; z-index: 9999; justify-content: center; align-items: center; }
        #viewer img { max-height: 90vh; max-width: 95vw; }

        .page { display: none; }
        #auth { position: fixed; inset: 0; background: #fff; z-index: 10000; display: flex; justify-content: center; align-items: center; flex-direction: column; }
    </style>
</head>
<body>

    <div id="viewer" onclick="this.style.display='none'">
        <img id="vImg" src="">
    </div>

    <div id="auth">
        <h2 style="color:#FF8C42">Chatter Box</h2>
        <input type="email" id="e" placeholder="Email" style="width:250px; padding:10px; margin:5px;">
        <input type="password" id="p" placeholder="Password" style="width:250px; padding:10px; margin:5px;">
        <button id="login" style="width:250px; margin:5px;">Login / Sign Up</button>
    </div>

    <div id="side" class="sidebar" style="display:none">
        <h3>Chatter Box</h3>
        <div class="nav-item active" onclick="show('home')">üè† Home</div>
        <div class="nav-item" onclick="show('search')">üîç Search</div>
        <div class="nav-item" onclick="show('profile')">üë§ Profile</div>
        <div id="adm" class="nav-item" style="display:none; color:gold" onclick="show('admin')">üëë Admin</div>
    </div>

    <div class="main">
        <div class="content">
            <div id="home" class="page" style="display:block">
                <div class="story-bar" id="sBar"></div>
                <input type="file" id="sInp" style="display:none" accept="image/*">
                <div id="feed"></div>
            </div>

            <div id="search" class="page">
                <input type="text" id="sQuery" placeholder="Search users..." style="padding:10px; width:100%">
                <div id="sRes"></div>
            </div>

            <div id="profile" class="page">
                <h2 id="pName">Name</h2>
                <div id="grid" style="display:grid; grid-template-columns: 1fr 1fr 1fr; gap:5px;"></div>
            </div>

            <div id="admin" class="page">
                <h2>Admin Control</h2>
                <div id="aList"></div>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, onAuthStateChanged, signInWithEmailAndPassword, createUserWithEmailAndPassword } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getDatabase, ref, set, push, onValue, remove } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

        const conf = { 
            apiKey: "AIzaSyAF0IDQU21LWJ2Rggb7J0rY4F6UlvZaVZg", 
            authDomain: "chatterbox-4b7dd.firebaseapp.com", 
            databaseURL: "https://chatterbox-4b7dd-default-rtdb.firebaseio.com", 
            projectId: "chatterbox-4b7dd" 
        };
        const app = initializeApp(conf);
        const auth = getAuth(app);
        const db = getDatabase(app);

        let me = null;
        const ADMIN = "eaton.garrett@icloud.com";

        window.show = (id) => {
            document.querySelectorAll('.page').forEach(p => p.style.display = 'none');
            document.getElementById(id).style.display = 'block';
        };

        // AUTH
        document.getElementById('login').onclick = () => {
            const email = document.getElementById('e').value;
            const pass = document.getElementById('p').value;
            signInWithEmailAndPassword(auth, email, pass).catch(() => {
                createUserWithEmailAndPassword(auth, email, pass).then(u => {
                    set(ref(db, 'users/' + u.user.uid), { email, name: email.split('@')[0], pfp: 'https://via.placeholder.com/150' });
                });
            });
        };

        onAuthStateChanged(auth, u => {
            if(u) {
                me = u;
                document.getElementById('auth').style.display = 'none';
                document.getElementById('side').style.display = 'flex';
                if(u.email === ADMIN) document.getElementById('adm').style.display = 'block';
                startApp();
            }
        });

        function startApp() {
            // STORIES LOADING
            onValue(ref(db, 'stories'), snap => {
                const bar = document.getElementById('sBar');
                bar.innerHTML = `<div class="story-circle" onclick="document.getElementById('sInp').click()"><div class="ring" style="background:#ccc"><div class="pfp"><div class="plus">+</div></div></div><small>Add</small></div>`;
                
                // Get people I follow
                onValue(ref(db, `following/${me.uid}`), fSnap => {
                    const following = fSnap.val() || {};
                    snap.forEach(s => {
                        if(following[s.key]) {
                            const data = s.val();
                            bar.innerHTML += `<div class="story-circle" onclick="view('${data.img}')"><div class="ring"><div class="pfp" style="background-image:url(${data.img})"></div></div><small>${data.name}</small></div>`;
                        }
                    });
                });
            });

            // STORY UPLOAD
            document.getElementById('sInp').onchange = (e) => {
                const reader = new FileReader();
                reader.onload = () => {
                    set(ref(db, `stories/${me.uid}`), { img: reader.result, name: me.email.split('@')[0], time: Date.now() });
                };
                reader.readAsDataURL(e.target.files[0]);
            };

            // SEARCH
            document.getElementById('sQuery').oninput = (e) => {
                const q = e.target.value.toLowerCase();
                onValue(ref(db, 'users'), snap => {
                    const res = document.getElementById('sRes');
                    res.innerHTML = "";
                    snap.forEach(u => {
                        if(u.key !== me.uid && u.val().name.toLowerCase().includes(q)) {
                            onValue(ref(db, `following/${me.uid}/${u.key}`), isF => {
                                const row = document.createElement('div');
                                row.className = 'user-row';
                                row.innerHTML = `<span>${u.val().name}</span> <button class="btn ${isF.exists()?'following':''}" onclick="follow('${u.key}', ${isF.exists()})">${isF.exists()?'Following':'Follow'}</button>`;
                                res.appendChild(row);
                            }, {onlyOnce: true});
                        }
                    });
                }, {onlyOnce: true});
            };
        }

        window.follow = (id, isF) => {
            if(isF) remove(ref(db, `following/${me.uid}/${id}`));
            else set(ref(db, `following/${me.uid}/${id}`), true);
            document.getElementById('sQuery').dispatchEvent(new Event('input'));
        };

        window.view = (img) => {
            document.getElementById('vImg').src = img;
            document.getElementById('viewer').style.display = 'flex';
        };
    </script>
</body>
</html>
